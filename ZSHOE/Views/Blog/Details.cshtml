
@model BlogPostItemsViewModel

@{
    ViewData["Title"] = "Details";

    IEnumerable<BlogPostComment> GetComments(BlogPostComment parent)
    {
        if (parent.ParentId != null)
            yield return parent;

        foreach (var item in parent.Children.SelectMany(c => GetComments(c)))
        {
            yield return item;
        }

    }
}

<main class="main">
    <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        <div class="container">
            <h1 class="page-title">Single Post <span>Blog</span></h1>
        </div><!-- End .container -->
    </div><!-- End .page-header -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item"><a href="blog.html">Blog</a></li>
                <li class="breadcrumb-item active" aria-current="page">Blog Single</li>
            </ol>
        </div><!-- End .container -->
    </nav><!-- End .breadcrumb-nav -->

    <div class="page-content">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <article class="entry single-entry">
                        <figure class="entry-media">
                            <img src="~/uploads/images/@Model.BlogPost.ImagePath" alt="">
                        </figure><!-- End .entry-media -->

                        <div class="entry-body">
                            <div class="entry-meta">
                                <span class="entry-author">
                                    by <a href="#">Zaman Safarov</a>
                                </span>
                                <span class="meta-separator">|</span>
                                <a href="#">@Model.BlogPost.PublishedDate?.ToString("MMM dd, yyyy")</a>
                                <span class="meta-separator">|</span>
                                <a href="#">@Model.BlogPost.Comments.Count() Comments</a>
                                @if (User.Identity.IsAuthenticated)
                                {
                                    <input type="hidden" data-user-id="@User.GetCurrentUserId()" data-blogpost-id="@Model.BlogPost.Id" />
                                    <button class="like-button dark @(Model.BlogPostLikes.Any(bpl => bpl.BlogPostId == Model.BlogPost.Id && bpl.CreatedByUserId == User.GetCurrentUserId()) ? "liked" : " ")">
                                        <div class="hand">
                                            <div class="thumb"></div>
                                        </div>
                                        <span>Like<span>d</span></span>
                                    </button>
                                }
                                <span class="meta-separator">|</span>
                                <p class="post-view"><i class="fa-sharp fa-regular fa-heart" style="padding-right:5px"></i>@Model.BlogPost.Likes.Count Likes</p>
                            </div><!-- End .entry-meta -->

                            <h2 class="entry-title">
                               @Model.BlogPost.Title
                            </h2><!-- End .entry-title -->

                            <div class="entry-cats">
                                in  @foreach (var tag in Model.BlogPost.TagCloud)
                                {
                                    <li>
                                        <a class="blog-tag__link d-inline-block" href="#">
                                            @tag.Tag.Text
                                        </a>
                                    </li>
                                }
                            </div><!-- End .entry-cats -->

                            <div class="entry-content editor-content">
                                <p>@Html.Raw(Model.BlogPost.Body)</p>

                                <div class="pb-1"></div><!-- End .mb-1 -->


                                <blockquote>
                                  <p>"@Html.Raw(Model.BlogPost.ShortDescription)"</p>
                                </blockquote>

                            </div><!-- End .entry-content -->

                            <div class="entry-footer row no-gutters flex-column flex-md-row">
                                <div class="col-md">
                                    <div class="entry-tags">
                                        <span>Tags:</span>
                                        @foreach (var tag in Model.BlogPost.TagCloud)
                                        { 
                                            <a href="#">@tag.Tag.Text</a> 
                                         }
                                    </div><!-- End .entry-tags -->
                                </div><!-- End .col -->

                                <div class="col-md-auto mt-2 mt-md-0">
                                    <div class="social-icons social-icons-color">
                                        <span class="social-label">Share this post:</span>
                                        <a href="#" class="social-icon social-facebook" title="Facebook" target="_blank"><i class="icon-facebook-f"></i></a>
                                        <a href="#" class="social-icon social-twitter" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>
                                        <a href="#" class="social-icon social-pinterest" title="Pinterest" target="_blank"><i class="icon-pinterest"></i></a>
                                        <a href="#" class="social-icon social-linkedin" title="Linkedin" target="_blank"><i class="icon-linkedin"></i></a>
                                    </div><!-- End .soial-icons -->
                                </div><!-- End .col-auto -->
                            </div><!-- End .entry-footer row no-gutters -->
                        </div><!-- End .entry-body -->

                        
                    </article><!-- End .entry -->

                    <nav class="pager-nav" aria-label="Page navigation">
                        <a class="pager-link pager-link-prev" href="#" aria-label="Previous" tabindex="-1">
                            Previous Post
                            <span class="pager-link-title">Cras iaculis ultricies nulla</span>
                        </a>

                        <a class="pager-link pager-link-next" href="#" aria-label="Next" tabindex="-1">
                            Next Post
                            <span class="pager-link-title">Praesent placerat risus</span>
                        </a>
                    </nav><!-- End .pager-nav -->

                    <div class="related-posts">
                        <h3 class="title">Recent Posts</h3><!-- End .title -->

                        <div class="owl-carousel owl-simple" data-toggle="owl"
                             data-owl-options='{
                                        "nav": false,
                                        "dots": true,
                                        "margin": 20,
                                        "loop": false,
                                        "responsive": {
                                            "0": {
                                                "items":1
                                            },
                                            "480": {
                                                "items":2
                                            },
                                            "768": {
                                                "items":3
                                            }
                                        }
                                    }'>
                            <article class="entry entry-grid">
                                <figure class="entry-media">
                                    <a href="single.html">
                                        <img src="assets/images/blog/grid/3cols/post-1.jpg" alt="image desc">
                                    </a>
                                </figure><!-- End .entry-media -->

                                <div class="entry-body">
                                    <div class="entry-meta">
                                        <a href="#">Nov 22, 2018</a>
                                        <span class="meta-separator">|</span>
                                        <a href="#">2 Comments</a>
                                    </div><!-- End .entry-meta -->

                                    <h2 class="entry-title">
                                        <a href="single.html">Cras ornare tristique elit.</a>
                                    </h2><!-- End .entry-title -->

                                    <div class="entry-cats">
                                        in <a href="#">Lifestyle</a>,
                                        <a href="#">Shopping</a>
                                    </div><!-- End .entry-cats -->
                                </div><!-- End .entry-body -->
                            </article><!-- End .entry -->

                            <article class="entry entry-grid">
                                <figure class="entry-media">
                                    <a href="single.html">
                                        <img src="assets/images/blog/grid/3cols/post-2.jpg" alt="image desc">
                                    </a>
                                </figure><!-- End .entry-media -->

                                <div class="entry-body">
                                    <div class="entry-meta">
                                        <a href="#">Nov 21, 2018</a>
                                        <span class="meta-separator">|</span>
                                        <a href="#">0 Comments</a>
                                    </div><!-- End .entry-meta -->

                                    <h2 class="entry-title">
                                        <a href="single.html">Vivamus ntulla necante.</a>
                                    </h2><!-- End .entry-title -->

                                    <div class="entry-cats">
                                        in <a href="#">Lifestyle</a>
                                    </div><!-- End .entry-cats -->
                                </div><!-- End .entry-body -->
                            </article><!-- End .entry -->

                            <article class="entry entry-grid">
                                <figure class="entry-media">
                                    <a href="single.html">
                                        <img src="assets/images/blog/grid/3cols/post-3.jpg" alt="image desc">
                                    </a>
                                </figure><!-- End .entry-media -->

                                <div class="entry-body">
                                    <div class="entry-meta">
                                        <a href="#">Nov 18, 2018</a>
                                        <span class="meta-separator">|</span>
                                        <a href="#">3 Comments</a>
                                    </div><!-- End .entry-meta -->

                                    <h2 class="entry-title">
                                        <a href="single.html">Utaliquam sollicitudin leo.</a>
                                    </h2><!-- End .entry-title -->

                                    <div class="entry-cats">
                                        in <a href="#">Fashion</a>,
                                        <a href="#">Lifestyle</a>
                                    </div><!-- End .entry-cats -->
                                </div><!-- End .entry-body -->
                            </article><!-- End .entry -->

                            <article class="entry entry-grid">
                                <figure class="entry-media">
                                    <a href="single.html">
                                        <img src="assets/images/blog/grid/3cols/post-4.jpg" alt="image desc">
                                    </a>
                                </figure><!-- End .entry-media -->

                                <div class="entry-body">
                                    <div class="entry-meta">
                                        <a href="#">Nov 15, 2018</a>
                                        <span class="meta-separator">|</span>
                                        <a href="#">4 Comments</a>
                                    </div><!-- End .entry-meta -->

                                    <h2 class="entry-title">
                                        <a href="single.html">Fusce pellentesque suscipit.</a>
                                    </h2><!-- End .entry-title -->

                                    <div class="entry-cats">
                                        in <a href="#">Travel</a>
                                    </div><!-- End .entry-cats -->
                                </div><!-- End .entry-body -->
                            </article><!-- End .entry -->
                        </div><!-- End .owl-carousel -->
                    </div><!-- End .related-posts -->

                    <div class="comments">
                        <h3 class="title">@Model.BlogPost.Comments.Count() Comments</h3><!-- End .title -->
                       
                        <ul class="commentAppend">
                            @foreach (var comment in Model.BlogPost.Comments.Where(c => c.ParentId == null))
                            {
                            <li>
                                <div class="comment" id="c-@comment.Id" data-comment-id="@comment.Id">
                                    <div class="comment-body">
                                        <a class="comment-reply">Reply</a>
                                        <div class="comment-user">
                                            <h4>@($"{comment.CreatedByUser?.Name} {comment.CreatedByUser?.Surname}")</h4>
                                            <span class="comment-date">@comment.CreatedDate.ToString("MMMM d, yyyy HH:mm")</span>
                                        </div><!-- End .comment-user -->

                                        <div class="comment-content">
                                            <p>@comment.Text</p>
                                        </div><!-- End .comment-content -->
                                    </div><!-- End .comment-body -->
                                </div><!-- End .comment -->
                                @foreach (var subComment in GetComments(comment))
                                {
                                <ul>
                                    <li>
                                        <div class="comment" id="c-@subComment.Id" data-comment-id="@subComment.Id">
                                            <div class="comment-body">
                                                <a class="comment-reply">Reply</a>
                                                <div class="comment-user">
                                                    <h4>@($"{subComment.CreatedByUser?.Name} {subComment.CreatedByUser?.Surname}")</h4>
                                                    <span class="comment-date">@subComment.CreatedDate.ToString("MMMM d, yyyy HH:mm")</span>
                                                </div><!-- End .comment-user -->

                                                <div class="comment-content">
                                                     <p> @subComment.Text</p>
                                                </div><!-- End .comment-content -->
                                            </div><!-- End .comment-body -->
                                        </div><!-- End .comment -->
                                    </li>
                                </ul>
                                }
                            </li>
                            }
                        </ul>
                       
                    </div><!-- End .comments -->
                    <div class="reply">
                        <div class="heading">
                            <h3 class="title">Leave A Reply</h3><!-- End .title -->
                            <p class="title-desc">Your email address will not be published. Required fields are marked *</p>
                        </div><!-- End .heading -->

                        <form method="post" id="replyForm">

                            <div id="replyToComment"></div>
                            <input type="hidden" name="postId" value="@Model.BlogPost.Id" />
                            <div class="comment mb-30">
                                <textarea name="Comment"
                                          class="form-control"
                                          id="comment-text"
                                          placeholder="Comment *"></textarea>
                            </div>
                            <button type="submit" class="btn btn-outline-primary-2">
                                <span>POST COMMENT</span>
                                <i class="icon-long-arrow-right"></i>
                            </button>
                        </form>
                    </div><!-- End .reply -->
                </div><!-- End .col-lg-9 -->

            </div><!-- End .row -->
        </div><!-- End .container -->
    </div><!-- End .page-content -->
</main><!-- End .main -->

@section addjs{
    <script>
        $(document).ready(function () {
            $(".comment-reply").click(function (e) {
                e.preventDefault();

                $("#replyToComment").html("<a href='javascript:removeSelectedReply()' class='remove-selected-comment' >&times</a>").append($(e.currentTarget).closest(".comment").clone());
            })

            $("#replyForm").submit(function (e) {
                e.preventDefault();

                let formData = new FormData(e.currentTarget);

                let toCommentId = $(`#replyToComment div.comment`).data("comment-id");


                //console.log("commentId",toCommentId);

                if (toCommentId != undefined) {
                    formData.set("commentId", toCommentId);
                }


                $.ajax({
                    url: `@Url.Action("PostComment", "Blog")`,
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    dataType: "json",
                    success: function (res) {
                        //console.log(res);
                    },
                    error: function (response) {

                        if (response.statusText == "parsererror") {
                            if (toCommentId != undefined) {
                                $(response.responseText).insertAfter($(`#c-${toCommentId}`));

                                $("#replyToComment").html("")
                                e.currentTarget.reset();
                                $("#comment-text").val("");
                            }
                            else {
                                $("div.comments ul.commentAppend").append($(response.responseText))
                                $("#comment-text").val("");
                            }
                        }

                        console.warn(response);
                    }
                });
            })
        })

        function removeSelectedReply(el) {
            $("#replyToComment").html("");
        }

        document.querySelectorAll('.like-button').forEach(button => {

            button.addEventListener('click', e => {
                button.classList.toggle('liked');
                if (button.classList.contains('liked')) {
                    gsap.fromTo(button, {
                        '--hand-rotate': 8
                    }, {
                        ease: 'none',
                        keyframes: [{
                            '--hand-rotate': -45,
                            duration: .16,
                            ease: 'none'
                        }, {
                            '--hand-rotate': 15,
                            duration: .12,
                            ease: 'none'
                        }, {
                            '--hand-rotate': 0,
                            duration: .2,
                            ease: 'none',
                            clearProps: true
                        }]
                    });
                }
            })
        })
        $(document).ready(function () {

            $(".like-button").click(function (e) {
                e.preventDefault();

                let obj = $("input[data-blogpost-id][data-user-id]").data();

                obj.isLiked = $(".like-button").hasClass("liked");


                $.ajax({
                    url: `@Url.Action("LikeUnlikeBlogPost", "Blog")`,
                    type: "POST",
                    data: obj,
                    dataType: "json",
                    contentType: "application/x-www-form-urlencoded",
                    success: function (res) {

                        if (res.error == false) {
                            $(".post-view").html(`<i class="fa-sharp fa-regular fa-heart" style="padding-right:5px"></i>${res.value} Likes`)
                        }
                        

                    },
                    error: function (res) {

                        if (res.error == true) {
                            toastr.error(res.message, "Xəta");
                        }

                    }
                })

            })
        })
    </script>


}

    @section addcss{
    <style>
        .like-button {
            --color: #1E2235;
            --color-hover: #1E2235;
            --color-active: #fff;
            --icon: #BBC1E1;
            --icon-hover: #8A91B4;
            --icon-active: #fff;
            --background: #fff;
            --background-hover: #fff;
            --background-active: #362A89;
            --border: #E1E6F9;
            --border-active: #362A89;
            --shadow: rgba(0, 17, 119, 0.025);
            display: block;
            outline: none;
            cursor: pointer;
            position: relative;
            border: 0;
            background: none;
            padding: 8px 12px 8px 23px;
            border-radius: 35px;
            line-height: 27px;
            font-family: inherit;
            font-weight: 600;
            font-size: 14px;
            color: var(--color);
            -webkit-appearance: none;
            margin: 0 14px;
            -webkit-tap-highlight-color: transparent;
            transition: color .2s linear;
        }

            .like-button.dark {
                --color: #c96;
                --color-hover: #fff;
                --color-active: #fff;
                --icon: #c96;
                --icon-hover: #fff;
                --icon-active: #fff;
                --background: #fff;
                --background-hover: #dfcab5;
                --background-active: #c96;
                --border: transparent;
                --border-active: transparent;
                --shadow: rgba(0, 7, 1, 0.05);
            }

            .like-button:hover {
                --icon: var(--icon-hover);
                --color: var(--color-hover);
                --background: var(--background-hover);
                --border-width: 2px;
            }

            .like-button:active {
                --scale: .95;
            }

            .like-button:not(.liked):hover {
                --hand-rotate: 8;
                --hand-thumb-1: -12deg;
                --hand-thumb-2: 36deg;
            }

            .like-button.liked {
                --span-x: 2px;
                --span-d-o: 1;
                --span-d-x: 0;
                --icon: var(--icon-active);
                --color: var(--color-active);
                --border: var(--border-active);
                --background: var(--background-active);
            }

            .like-button:before {
                content: '';
                min-width: 103px;
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
                border-radius: inherit;
                transition: background .2s linear, transform .2s, box-shadow .2s linear;
                transform: scale(var(--scale, 1)) translateZ(0);
                background: var(--background);
                box-shadow: inset 0 0 0 var(--border-width, 1px) var(--border), 0 4px 8px var(--shadow), 0 8px 20px var(--shadow);
            }

            .like-button .hand {
                width: 11px;
                height: 11px;
                border-radius: 2px 0 0 0;
                background: var(--icon);
                position: relative;
                margin: 10px 8px 0 0;
                transform-origin: -5px -1px;
                transition: transform .25s, background .2s linear;
                transform: rotate(calc(var(--hand-rotate, 0) * 1deg)) translateZ(0);
            }

                .like-button .hand:before, .button .hand:after {
                    content: '';
                    background: var(--icon);
                    position: absolute;
                    transition: background .2s linear, box-shadow .2s linear;
                }

                .like-button .hand:before {
                    left: -5px;
                    bottom: 0;
                    height: 12px;
                    width: 4px;
                    border-radius: 1px 1px 0 1px;
                }

                .like-button .hand:after {
                    right: -3px;
                    top: 0;
                    width: 4px;
                    height: 4px;
                    border-radius: 0 2px 2px 0;
                    background: var(--icon);
                    box-shadow: -0.5px 4px 0 var(--icon), -1px 8px 0 var(--icon), -1.5px 12px 0 var(--icon);
                    transform: scaleY(0.6825);
                    transform-origin: 0 0;
                }

                .like-button .hand .thumb {
                    background: var(--icon);
                    width: 10px;
                    height: 4px;
                    border-radius: 2px;
                    transform-origin: 2px 2px;
                    position: absolute;
                    left: 0;
                    top: 0;
                    transition: transform .25s, background .2s linear;
                    transform: scale(0.85) translateY(-0.5px) rotate(var(--hand-thumb-1, -45deg)) translateZ(0);
                }

                    .like-button .hand .thumb:before {
                        content: '';
                        height: 4px;
                        width: 7px;
                        border-radius: 2px;
                        transform-origin: 2px 2px;
                        background: var(--icon);
                        position: absolute;
                        left: 7px;
                        top: 0;
                        transition: transform .25s, background .2s linear;
                        transform: rotate(var(--hand-thumb-2, -45deg)) translateZ(0);
                    }

            .like-button .hand,
            .like-button span {
                display: inline-block;
                vertical-align: top;
            }

                .like-button .hand span,
                .like-button span span {
                    opacity: var(--span-d-o, 0);
                    transition: transform .25s, opacity .2s linear;
                    transform: translateX(var(--span-d-x, 4px)) translateZ(0);
                }

            .like-button > span {
                transition: transform .25s;
                transform: translateX(var(--span-x, 4px)) translateZ(0);
            }

        body .dribbble {
            position: fixed;
            display: block;
            right: 20px;
            bottom: 20px;
        }

            body .dribbble img {
                display: block;
                height: 28px;
            }

        body .twitter {
            position: fixed;
            display: block;
            right: 64px;
            bottom: 14px;
        }

            body .twitter svg {
                width: 32px;
                height: 32px;
                fill: #1da1f2;
            }

    </style>
}